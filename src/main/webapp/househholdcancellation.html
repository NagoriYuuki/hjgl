<!DOCTYPE html>
<html lang="en">
<head>
    <base href="http://localhost:8080/">
    <meta charset="UTF-8">
    <title>户籍删除申请管理</title>
    <link rel="stylesheet" href="static/layui/css/layui.css">
</head>
<body>
<table class="layui-table" lay-data="{toolbar:'#toptools', url:'/HouseholdCancellation/list', page:true, id:'datalist'}" lay-filter="datalist">
    <thead>
    <tr>
        <th lay-data="{field:'householdcancellationid',}">申请编号</th>
        <th lay-data="{templet:function(d){return d.person.personname}}">姓名</th>
        <th lay-data="{field:'householdcancellationhouseholdid',}">所属户籍</th>
        <th lay-data="{templet:function(d){return d.admin.adminname}}">管理员姓名</th>
        <th lay-data="{templet:function(d){
  if(d.householdcancellationstatus === '已同意'){
    return '<span style=\'color:green\'>已同意</span>';
  } else if(d.householdcancellationstatus === '已拒绝'){
    return '<span style=\'color:gray\'>已拒绝</span>';
  } else {
    return '<span style=\'color:red\'>未批阅</span>';
  }
}}">批阅申请状态</th>
        <th lay-data="{toolbar:'#linetools'}">操作</th>
    </tr>
    </thead>
</table>

<!--新增窗口组件-->
<div id="addWin" lay-filter="addWin" class="layui-form" style="display: none">
    <div class="layui-form-item">
        <label class="layui-form-label">部门编号</label>
        <div class="layui-input-block">
            <input type="text" name="code" placeholder="请输入部门编号" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">部门名称</label>
        <div class="layui-input-block">
            <input type="text" name="info" placeholder="请输入部门名称" autocomplete="off" class="layui-input">
        </div>
    </div>
</div>

<!--编辑窗口组件-->
<!-- <div id="editWin" lay-filter="editWin" class="layui-form" style="display: none">
    <input type="hidden" name="id" >
    <div class="layui-form-item">
        <label class="layui-form-label">部门编号</label>
        <div class="layui-input-block">
            <input type="text" name="code" placeholder="请输入部门编号" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">部门名称</label>
        <div class="layui-input-block">
            <input type="text" name="info" placeholder="请输入部门名称" autocomplete="off" class="layui-input">
        </div>
    </div>
</div> -->

<!--表格头部工具栏-->
<!--<script type="text/html" id="toptools">-->
<!--    <button type="button" class="layui-btn layui-btn-sm"-->
<!--            lay-event="add">新增</button>-->
<!--</script>-->

<!--表格行内工具栏-->
<script type="text/html" id="linetools">
    {{#   if(!d.agree){   }}
    <button type="button" class="layui-btn layui-btn-xs layui-bg-orange"
            lay-event="agree">同意</button>
    {{#         }     }}
<!--    <button type="button" class="layui-btn layui-btn-xs layui-bg-red" lay-event="refuse">拒绝</button>-->
<!--    <button type="button" class="layui-btn layui-btn-xs layui-bg-gray" lay-event="delete">删除</button>-->
</script>

<script src="static/layui/layui.all.js"></script>
<script>
    /*声明layui内部对象*/
    const $ = layui.$;
    const table = layui.table;
    const layer = layui.layer;
    const form = layui.form;

    $.ajax({
        url: "login/islogin",
        async: false,
        success: function(result) {
            if(result == '') {
                top.location.href = "login.html";
            }
        }
    });

    /*声明表格头部工具栏事件*/
    table.on("toolbar(datalist)", function(obj) {
        var event = obj.event;
        if(event == 'check') {
            var name = $("[name='name']").val();
            var booktitle = $("[name='booktitle']").val();
            table.reload("datalist", { where: { name: name, booktitle: booktitle } });
        }
        name = $("[name='name']").val(name);
        booktitle = $("[name='booktitle']").val(booktitle);
    }); 

    /*行内工具栏的监听事件*/
    table.on("tool(datalist)", function(obj) {
        var event = obj.event;
        var data = obj.data; // 点击按钮所在行的数据
        if (event == 'agree') {
            // 点击同意按钮后执行的操作
            layer.confirm("确认同意此户籍注销申请吗？", function() {
                $.ajax({
                    method: "post",
                    url: "HouseholdCancellation/agree",
                    data: {
                        householdcancellationid: data.householdcancellationid,
                        personname: data.person.personname,
                        householdid: data.person.householdid,
                        adminname: data.admin.adminname,
                        status: data.agree,
                        householdcancellationhouseholdid: data.householdcancellationhouseholdid,
                    },
                    success: function(result) {
                        console.log("Success response:", result);
                        obj.update({
                            agree: '已同意'
                        });
                        console.log("Updated data:", obj.data);
                        table.reload("datalist");
                        layer.closeAll();
                        layer.msg("已同意", { icon: 1, time: 1800 });
                    },

                    error: function() {
                        layer.msg("同意失败，请稍后重试", { icon: 2, time: 1800 });
                    }
                });
            });
        } else if (event == 'refuse') {
            // 点击拒绝按钮后执行的操作
            layer.confirm("确认拒绝此户籍注销申请吗?", function() {
                $.ajax({
                    url: "HouseholdCancellation/refuse",
                    data: {                         householdcancellationid: data.householdcancellationid,
                        personname: data.person.personname,
                        householdid: data.person.householdid,
                        adminname: data.admin.adminname,
                        status: data.refuse,
                        householdcancellationhouseholdid: data.householdcancellationhouseholdid, },
                    success: function(result) {
                        console.log("Success response:", result);
                        obj.update({
                            agree: '已拒绝'
                        });
                        console.log("Updated data:", obj.data);
                        table.reload("datalist");
                        layer.closeAll();
                        layer.msg("已拒绝", { icon: 1, time: 1800 });
                    },

                    error: function() {
                        layer.msg("拒绝失败，请稍后重试", { icon: 2, time: 1800 });
                    }
                });
            });
        } else if (event == 'delete') {
            // 点击删除按钮后执行的操作
            layer.confirm("确认要删除该行数据吗?", function() {
                $.ajax({
                    url: "HouseholdCancellation/delete",
                    data: { recordid: data.householdcancellationid },
                    success: function() {
                        // 刷新表格
                        table.reload("datalist");
                        layer.msg("删除成功", { icon: 1, time: 1800 });
                    }
                });
            });
        }
    });
</script>
</body>
</html>
